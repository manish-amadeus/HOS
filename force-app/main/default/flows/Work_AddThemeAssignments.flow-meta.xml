<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>56.0</apiVersion>
    <assignments>
        <description>Add the Theme Assignment to a collection to be deleted</description>
        <name>AssignToDeleteCollection</name>
        <label>AssignToDeleteCollection</label>
        <locationX>682</locationX>
        <locationY>355</locationY>
        <assignmentItems>
            <assignToReference>varDeleteThemeAssignments</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>LoopThemeAssignments</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>LoopThemeAssignments</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Counts the number of existing Theme Assignments associated with the Work record</description>
        <name>CountExistingThemeAssignments</name>
        <label>CountExistingThemeAssignments</label>
        <locationX>217</locationX>
        <locationY>527</locationY>
        <assignmentItems>
            <assignToReference>varCountOfExistingThemeAssignments</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>GetExistingThemeAssignments</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>NewOrUpdatedRecord</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Counts the number of Theme Assignments waiting for creation</description>
        <name>CountOfNewThemeAssignments</name>
        <label>CountOfNewThemeAssignments</label>
        <locationX>817</locationX>
        <locationY>149</locationY>
        <assignmentItems>
            <assignToReference>varCountOfNewThemeAssignments</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>varNewThemeAssignmentCollection</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>CreateThemeAssignments</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>CountOfThemeAssignmentsToDelete</name>
        <label>CountOfThemeAssignmentsToDelete</label>
        <locationX>923</locationX>
        <locationY>546</locationY>
        <assignmentItems>
            <assignToReference>varCountOfThemeAssignmentsToDelete</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>varDeleteThemeAssignments</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>DeleteThemeAssignmentsDecision</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Uses the Theme from the field &quot;Theme 1&quot; on the Work record to create a new Theme Assignment</description>
        <name>ThemeOne</name>
        <label>ThemeOne</label>
        <locationX>418</locationX>
        <locationY>110</locationY>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentRecord.agf__Work__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentRecord.agf__Theme__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>formulaThemeName</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentRecord.AH_CreatedByAutomation__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentCollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varNewThemeAssignmentRecord</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>NumberOfThemes</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Uses the Theme in the &quot;Theme 2&quot; field to create a new Theme Assignment record</description>
        <name>ThemeTwo</name>
        <label>ThemeTwo</label>
        <locationX>752</locationX>
        <locationY>31</locationY>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentRecord.agf__Work__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentRecord.agf__Theme__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.AH_Theme_Two__r.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentRecord.AH_CreatedByAutomation__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewThemeAssignmentCollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varNewThemeAssignmentRecord</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>CountOfNewThemeAssignments</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>Decides if new Theme Assignments need to be created after deleting existing Theme Assignments</description>
        <name>CreateNewThemeAssignmentsDecision</name>
        <label>CreateNewThemeAssignmentsDecision</label>
        <locationX>933</locationX>
        <locationY>303</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>CreateNewThemeAssignments</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>ThemeOne</targetReference>
            </connector>
            <label>CreateNewThemeAssignments</label>
        </rules>
    </decisions>
    <decisions>
        <description>If there are no Theme Assignments to delete, the Flow moves on to create new Theme Assignments (if applicable). Otherwise, it will delete theme assignments.</description>
        <name>DeleteThemeAssignmentsDecision</name>
        <label>DeleteThemeAssignmentsDecision</label>
        <locationX>1071</locationX>
        <locationY>488</locationY>
        <defaultConnector>
            <targetReference>CreateNewThemeAssignmentsDecision</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>DeleteThemeAssignments</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varCountOfThemeAssignmentsToDelete</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>DeleteExistingThemeAssignments</targetReference>
            </connector>
            <label>DeleteThemeAssignments</label>
        </rules>
    </decisions>
    <decisions>
        <description>Decides if the Work record is a new record, one of the Theme fields has been changed or if one of the Themes has been deleted.</description>
        <name>NewOrUpdatedRecord</name>
        <label>NewOrUpdatedRecord</label>
        <locationX>304</locationX>
        <locationY>378</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>NewRecordOrNewThemes</name>
            <conditionLogic>9 and (1 or (2 and (3 and 5 and 6) or (4 and 7 and 8)))</conditionLogic>
            <conditions>
                <leftValueReference>$Record__Prior.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varCountOfExistingThemeAssignments</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>ThemeOne</targetReference>
            </connector>
            <label>NewRecordOrNewThemes</label>
        </rules>
        <rules>
            <name>UpdatedTheme</name>
            <conditionLogic>(1 AND 2 AND 3) OR (4 AND 5 AND 6)</conditionLogic>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.AH_Theme_One__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record.AH_Theme_Two__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.AH_Theme_Two__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record.AH_Theme_One__c</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LoopThemeAssignments</targetReference>
            </connector>
            <label>UpdatedTheme</label>
        </rules>
        <rules>
            <name>DeletedTheme</name>
            <conditionLogic>(1 AND 2 and 3) OR (4 and 5 and 6)</conditionLogic>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record__Prior.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LoopThemeAssignments</targetReference>
            </connector>
            <label>DeletedTheme</label>
        </rules>
    </decisions>
    <decisions>
        <description>Determines how many of the &quot;Theme&quot; fields on the Work record are populated</description>
        <name>NumberOfThemes</name>
        <label>NumberOfThemes</label>
        <locationX>565</locationX>
        <locationY>21</locationY>
        <defaultConnector>
            <targetReference>CountOfNewThemeAssignments</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>One Theme</defaultConnectorLabel>
        <rules>
            <name>TwoThemes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.AH_Theme_One__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.AH_Theme_Two__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>ThemeTwo</targetReference>
            </connector>
            <label>Two Themes</label>
        </rules>
    </decisions>
    <decisions>
        <description>Decides if the new/updated Theme 1 or Theme 2 matches a current Theme Assignment on the Work record</description>
        <name>ThemeMatchesThemeAssignmentDecision</name>
        <label>ThemeMatchesThemeAssignmentDecision</label>
        <locationX>717</locationX>
        <locationY>554</locationY>
        <defaultConnector>
            <targetReference>LoopThemeAssignments</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>ThemeMatchesThemeAssignment</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>LoopThemeAssignments.agf__Theme__r.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.AH_Theme_One__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>LoopThemeAssignments.agf__Theme__r.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.AH_Theme_Two__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>LoopThemeAssignments.agf__Theme__r.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>$Record.AH_Theme_One__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>LoopThemeAssignments.agf__Theme__r.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>$Record.AH_Theme_Two__c</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>AssignToDeleteCollection</targetReference>
            </connector>
            <label>ThemeMatchesThemeAssignment</label>
        </rules>
    </decisions>
    <description>NICC-063573; Creates Theme Assignment child records for the Work record using the Theme 1 and Theme 2 fields</description>
    <environments>Default</environments>
    <formulas>
        <description>If a Work record has two Themes and Theme 1 is deleted, leaving only theme 2, this formula will assign Theme 2 to the Theme Assignment.</description>
        <name>formulaThemeName</name>
        <dataType>String</dataType>
        <expression>IF(ISBLANK({!$Record.AH_Theme_One__c}) ,
{!$Record.AH_Theme_Two__c}, 
{!$Record.AH_Theme_One__c})</expression>
    </formulas>
    <interviewLabel>Work - Add Theme Assignments {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Work - Add Theme Assignments</label>
    <loops>
        <description>Loops the existing Theme Assignments associated with the record</description>
        <name>LoopThemeAssignments</name>
        <label>LoopThemeAssignments</label>
        <locationX>545</locationX>
        <locationY>437</locationY>
        <collectionReference>GetExistingThemeAssignments</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>ThemeMatchesThemeAssignmentDecision</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>CountOfThemeAssignmentsToDelete</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>CreateThemeAssignments</name>
        <label>CreateThemeAssignments</label>
        <locationX>1028</locationX>
        <locationY>52</locationY>
        <inputReference>varNewThemeAssignmentCollection</inputReference>
    </recordCreates>
    <recordDeletes>
        <name>DeleteExistingThemeAssignments</name>
        <label>DeleteExistingThemeAssignments</label>
        <locationX>1251</locationX>
        <locationY>414</locationY>
        <connector>
            <targetReference>CreateNewThemeAssignmentsDecision</targetReference>
        </connector>
        <inputReference>varDeleteThemeAssignments</inputReference>
    </recordDeletes>
    <recordLookups>
        <description>Gets all current existing Theme Assignments associated with the Work record</description>
        <name>GetExistingThemeAssignments</name>
        <label>GetExistingThemeAssignments</label>
        <locationX>122</locationX>
        <locationY>384</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>CountExistingThemeAssignments</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>agf__Work__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>agf__ADM_Theme_Assignment__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <start>
        <locationX>72</locationX>
        <locationY>37</locationY>
        <connector>
            <targetReference>GetExistingThemeAssignments</targetReference>
        </connector>
        <filterFormula>AND(ISNEW() ,OR(NOT(ISBLANK({!$Record.AH_Theme_One__c})),NOT(ISBLANK({!$Record.AH_Theme_Two__c}))
)
)
||
AND(
NOT(ISNEW()),
OR(ISCHANGED({!$Record.AH_Theme_One__c}) ,ISCHANGED({!$Record.AH_Theme_Two__c})
)
)</filterFormula>
        <object>agf__ADM_Work__c</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <description>Variable to hold the count of existing Theme Assignments on the Work record</description>
        <name>varCountOfExistingThemeAssignments</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <description>Counts the number of Theme Assignment records created</description>
        <name>varCountOfNewThemeAssignments</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>varCountOfThemeAssignmentsToDelete</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <description>Variable to hold a collection of Theme Assignment records to delete</description>
        <name>varDeleteThemeAssignments</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>agf__ADM_Theme_Assignment__c</objectType>
    </variables>
    <variables>
        <description>Holds the name of the DML Element. Used to map to the AH Error Log subflow</description>
        <name>varElementName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <description>Holds a collection of new Theme Assignment records</description>
        <name>varNewThemeAssignmentCollection</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>agf__ADM_Theme_Assignment__c</objectType>
    </variables>
    <variables>
        <description>Temporary record to hold details of a new Theme Assignment record</description>
        <name>varNewThemeAssignmentRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>agf__ADM_Theme_Assignment__c</objectType>
    </variables>
</Flow>
