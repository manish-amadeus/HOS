<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <description>Sends an email alert to the user who created the Request record to let them know the Request was created and a link to the record</description>
        <name>OM_New_Request_Record</name>
        <label>OM New Request Record</label>
        <locationX>1078</locationX>
        <locationY>443</locationY>
        <actionName>Request__c.Order_Management_New_Request_Record</actionName>
        <actionType>emailAlert</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>SObjectRowId</name>
            <value>
                <elementReference>requestRecordId</elementReference>
            </value>
        </inputParameters>
    </actionCalls>
    <actionCalls>
        <description>Sends an email to a system admin with details about a missing Record Type ID</description>
        <name>recordTypeIdMissingEmail</name>
        <label>Record Type ID Missing Email</label>
        <locationX>261</locationX>
        <locationY>590</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>recordTypeIdErrorEmailTemplate</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <stringValue>kimberly.contreraz@amadeus.com</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>senderAddress</name>
            <value>
                <stringValue>kimberly.contreraz@amadeus.com</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>Flow Contract Validation Request Failed - Missing Record Type ID</stringValue>
            </value>
        </inputParameters>
    </actionCalls>
    <apiVersion>52.0</apiVersion>
    <assignments>
        <description>Holds the ID of the new Request record just created</description>
        <name>requestRecordIdAssignment</name>
        <label>Request Record ID</label>
        <locationX>877</locationX>
        <locationY>289</locationY>
        <assignmentItems>
            <assignToReference>requestRecordId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>createContactValidationRequest</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>processingScreen</targetReference>
        </connector>
    </assignments>
    <choices>
        <name>oppStageClosedWonChoice</name>
        <choiceText>{!oppStageClosedWonValue}</choiceText>
        <dataType>String</dataType>
        <value>
            <stringValue>Closed Won</stringValue>
        </value>
    </choices>
    <constants>
        <description>Holds the email address of the System Admin to send email alerts to for error resolution</description>
        <name>emailSystemAdministrator</name>
        <dataType>String</dataType>
        <value>
            <stringValue>kimberly.contreraz@amadeus.com</stringValue>
        </value>
    </constants>
    <constants>
        <name>oppStageClosedWonValue</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Closed Won</stringValue>
        </value>
    </constants>
    <decisions>
        <name>recordTypeIdPopulated</name>
        <label>Record Type Id Populated</label>
        <locationX>244</locationX>
        <locationY>380</locationY>
        <defaultConnector>
            <targetReference>getOpportunities</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Record Type ID Populated</defaultConnectorLabel>
        <rules>
            <name>recordTypeIDNULL</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>recordTypeId</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Record_Type_ID_NULL_Error_Screen</targetReference>
            </connector>
            <label>Record Type ID NULL</label>
        </rules>
    </decisions>
    <description>Updates the Stage of the OPportunity to Closed Won and then creates a Contract Validation Request in the Request object</description>
    <interviewLabel>Opportunity - Create Contract Validation Request {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Opportunity - Create Contract Validation Request</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordCreates>
        <description>Creates a new Contract Validation Request record in the Request object</description>
        <name>createContactValidationRequest</name>
        <label>Create Contact Validation Request</label>
        <locationX>1026</locationX>
        <locationY>76</locationY>
        <connector>
            <targetReference>requestRecordIdAssignment</targetReference>
        </connector>
        <faultConnector>
            <targetReference>contractValidationRequestErrorScreen</targetReference>
        </faultConnector>
        <inputAssignments>
            <field>Account__c</field>
            <value>
                <elementReference>getOpportunities.AccountId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Open_Time__c</field>
            <value>
                <elementReference>$Flow.CurrentDateTime</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>OwnerId</field>
            <value>
                <elementReference>getQueueId.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>RecordTypeId</field>
            <value>
                <elementReference>recordTypeId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Related_Opportunity__c</field>
            <value>
                <elementReference>oppId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Request_Contact__c</field>
            <value>
                <elementReference>$User.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Request_Status__c</field>
            <value>
                <stringValue>New</stringValue>
            </value>
        </inputAssignments>
        <object>Request__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordDeletes>
        <description>Deletes the newly created Request record if the Opportunity doesn&apos;t get updated correctly</description>
        <name>deleteRequestRecord</name>
        <label>Delete Request Record</label>
        <locationX>1425</locationX>
        <locationY>201</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>requestRecordId</elementReference>
            </value>
        </filters>
        <object>Request__c</object>
    </recordDeletes>
    <recordLookups>
        <description>Gets the ID of the Opportunity</description>
        <name>getOpportunities</name>
        <label>Get Opportunities</label>
        <locationX>521</locationX>
        <locationY>202</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>updateOpportunityStage</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oppId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Gets the Id of the Queue to assign the Request record to upon record creation</description>
        <name>getQueueId</name>
        <label>Get Queue Id</label>
        <locationX>817</locationX>
        <locationY>112</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>createContactValidationRequest</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>queueDevName</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Group</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Gets the ID of the record type called &quot;Contract Validation Request&quot; from the Request object</description>
        <name>getRecordTypeId</name>
        <label>Get Record Type Id</label>
        <locationX>251</locationX>
        <locationY>211</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>recordTypeIdPopulated</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Contract_Validation_Request</stringValue>
            </value>
        </filters>
        <object>RecordType</object>
        <outputAssignments>
            <assignToReference>recordTypeId</assignToReference>
            <field>Id</field>
        </outputAssignments>
    </recordLookups>
    <recordUpdates>
        <description>Updates the Stage of the Opportunity to Closed Won</description>
        <name>updateOpportunityStage</name>
        <label>Update Opportunity Stage</label>
        <locationX>661</locationX>
        <locationY>277</locationY>
        <connector>
            <targetReference>getQueueId</targetReference>
        </connector>
        <faultConnector>
            <targetReference>faultForOpportunityUpdate</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oppId</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>StageName</field>
            <value>
                <stringValue>Closed Won</stringValue>
            </value>
        </inputAssignments>
        <object>Opportunity</object>
    </recordUpdates>
    <screens>
        <description>This screen will display an error message to a user if the Contract Validation Request record cannot be created.</description>
        <name>contractValidationRequestErrorScreen</name>
        <label>Contract Validation Request Error Screen</label>
        <locationX>1209</locationX>
        <locationY>80</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>errorScreenDisplayText</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(244, 9, 9);&quot;&gt;&lt;span class=&quot;ql-cursor&quot;&gt;ï»¿&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(62, 62, 60);&quot;&gt;Unfortunately, we are unable to create your Contract Validation Request at this time. Please review the error message below for issues that need to be resolved or contact your system administrator for more information.&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(244, 4, 4);&quot;&gt;{!$Flow.FaultMessage}&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>false</showHeader>
    </screens>
    <screens>
        <description>This screen displays to a user if an Opportunity cannot be updated to Closed Won.</description>
        <name>faultForOpportunityUpdate</name>
        <label>Fault for Update Opportunity</label>
        <locationX>639</locationX>
        <locationY>470</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>OppUpdateFaultText</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Your Opportunity cannot be updated to Closed Won and your Contract Validation Request cannot be created at this time. Please review the error message below for issues that need to be resolved or contact your system administrator for assistance.&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(234, 27, 27);&quot;&gt;{!$Flow.FaultMessage}&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(18, 18, 18);&quot;&gt;Click Finish to return to your Opportunity.&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>false</showHeader>
    </screens>
    <screens>
        <name>opportunityStageScreen</name>
        <label>Opportunity Stage Screen</label>
        <locationX>43</locationX>
        <locationY>195</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>getRecordTypeId</targetReference>
        </connector>
        <fields>
            <name>opportunityStagePicklist</name>
            <choiceReferences>oppStageClosedWonChoice</choiceReferences>
            <dataType>String</dataType>
            <defaultSelectedChoiceReference>oppStageClosedWonChoice</defaultSelectedChoiceReference>
            <fieldText>Opportunity Stage</fieldText>
            <fieldType>DropdownBox</fieldType>
            <isRequired>false</isRequired>
        </fields>
        <fields>
            <name>oppScreenDisplayText</name>
            <fieldText>&lt;p&gt;Click the Next button to create your Contract Validation Request&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>false</showHeader>
    </screens>
    <screens>
        <name>processingScreen</name>
        <label>Processing Screen</label>
        <locationX>908</locationX>
        <locationY>443</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>OM_New_Request_Record</targetReference>
        </connector>
        <fields>
            <name>processingScreenDisplayText</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(62, 62, 60);&quot;&gt;Your Contract Validation Request is being processed and will be available momentarily. Click the Next button to finish processing and return to the Opportunity.&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>false</showHeader>
    </screens>
    <screens>
        <name>Record_Type_ID_NULL_Error_Screen</name>
        <label>Record Type ID NULL Error Screen</label>
        <locationX>111</locationX>
        <locationY>510</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>recordTypeIdMissingEmail</targetReference>
        </connector>
        <fields>
            <name>nullRecordTypeIDText</name>
            <fieldText>&lt;p&gt;We are unable to process your Contract Validation Request at this time. Please click Next to send an email to your system administrator for resolution.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>false</showHeader>
    </screens>
    <start>
        <locationX>44</locationX>
        <locationY>38</locationY>
        <connector>
            <targetReference>opportunityStageScreen</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <textTemplates>
        <name>getOpportunityIdFailedTextTemplate</name>
        <isViewedAsPlainText>false</isViewedAsPlainText>
        <text>&lt;p&gt;Error: {!$Flow.FaultMessage}&lt;/p&gt;&lt;p&gt;Flow Name: Opportunity - Contract Validation Request&lt;/p&gt;&lt;p&gt;Element: Get Oportunity Id&lt;/p&gt;</text>
    </textTemplates>
    <textTemplates>
        <description>This text template contains details of an issue with getting the RecordType ID to create the Contract Validation Request</description>
        <name>recordTypeIdErrorEmailTemplate</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>The below-named flow has failed to run properly. The Flow failed to properly record the Record Type ID. Please review for resolution.

Name of the Flow: Opportunity - Contract Validation Request

Error Location: Get Record Type ID

Record ID: {!oppId}

Running User ID: {!$User.Id}

Running User Name: {!$User.FirstName} {!$User.LastName}</text>
    </textTemplates>
    <variables>
        <description>Holds the Id of the Opportunity used to create the Contract Validation Request</description>
        <name>oppId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>queueDevName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>Order_Mgmt_Contract_Validation_Request</stringValue>
        </value>
    </variables>
    <variables>
        <name>queueRecordSet</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Group</objectType>
    </variables>
    <variables>
        <description>Holds the Id of the Record Type &quot;Contract Validation Request&quot; from the Request object</description>
        <name>recordTypeId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>requestRecordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
</Flow>
