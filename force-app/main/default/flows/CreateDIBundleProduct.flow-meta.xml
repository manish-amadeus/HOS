<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>52.0</apiVersion>
    <assignments>
        <description>Adds a new Deployment Instance record to the collection that will create actual records</description>
        <name>AddToCollection</name>
        <label>AddToCollection</label>
        <locationX>602</locationX>
        <locationY>434</locationY>
        <assignmentItems>
            <assignToReference>CreateNewDeploymentInstanceColl</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>NewDeploymentInstanceRecord</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>LoopSubActRecords</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>AssignNewDIRecord</name>
        <label>AssignNewDIRecord</label>
        <locationX>1143</locationX>
        <locationY>468</locationY>
        <assignmentItems>
            <assignToReference>NewDeploymentInstanceRecord.Product2Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>ProductDetail.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>NewDeploymentInstanceRecord.AccountId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>AccountId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>NewDeploymentInstanceRecord.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Purchased</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>NewDeploymentInstanceRecord.Name</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>ProductDetail.DI_Name_Preview__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>LoopNewDepInsCollection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Counts the number of existing Deployment Instance records on the Account.</description>
        <name>CountExistingDeploymentInstances</name>
        <label>CountExistingDeploymentInstances</label>
        <locationX>1333</locationX>
        <locationY>58</locationY>
        <assignmentItems>
            <assignToReference>CountDeploymentInstances</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>ExistingDeploymentInstancesColl</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>DecisionHasExistingDIRecords</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>If the Account has existing DI records, the Flow will loop through to see if an existing DI record has a DI Index that matches a DI Index of a new record that needs to be created. If the Flow finds an existing DI Index on an Account, the current item in the loop is discarded and the path will take the Flow back to &quot;Loop SA records&quot;. If no existing DI records are found, the Flow continues to the next part.</description>
        <name>DecisionHasExistingDIRecords</name>
        <label>DecisionHasExistingDIRecords</label>
        <locationX>1471</locationX>
        <locationY>165</locationY>
        <defaultConnector>
            <targetReference>AssignNewDIRecord</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>NoDIRecordsFound</defaultConnectorLabel>
        <rules>
            <name>HasDIRecords</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>CountDeploymentInstances</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LoopDIRecords</targetReference>
            </connector>
            <label>HasDIRecords</label>
        </rules>
    </decisions>
    <decisions>
        <description>Decides whether a Deployment Instance record exists for the new record to be created. If it exists, the loop will skip to the next Subscription Activation record. If it doesn&apos;t exist, the new record will be added to the collection of records to create.</description>
        <name>DIRecordCompareDecision</name>
        <label>DIRecordCompareDecision</label>
        <locationX>899</locationX>
        <locationY>345</locationY>
        <defaultConnector>
            <targetReference>LoopDIRecords</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>NoMatchingDIRecord</defaultConnectorLabel>
        <rules>
            <name>DIRecordExists</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>ProductDetail.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>LoopDIRecords.Product2Id</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>DI_Index_Details.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>LoopDIRecords.Product2.DI_Index__r.Name</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LoopSubActRecords</targetReference>
            </connector>
            <label>DIRecordExists</label>
        </rules>
    </decisions>
    <decisions>
        <description>This decision node determines if a Subscription Activation record needs a Deployment Instance (DI) created. A DI will need to be created if the &quot;Product ID&quot; field (which is the ID of the Opportunity Product) on the Subscription Activiation record is blank. If it&apos;s populated, another automated process will create a DI for the product.</description>
        <name>NeedDICreatedDecision</name>
        <label>Need DI Created</label>
        <locationX>387</locationX>
        <locationY>74</locationY>
        <defaultConnector>
            <targetReference>LoopSubActRecords</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No DI Needed</defaultConnectorLabel>
        <rules>
            <name>NeedDICreated</name>
            <conditionLogic>1 AND (2 OR 3 or 4)</conditionLogic>
            <conditions>
                <leftValueReference>LoopSubActRecords.Product_ID__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>LoopSubActRecords.Group__r.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Res</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>LoopSubActRecords.Group__r.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Service Optimization</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>LoopSubActRecords.Group__r.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>GMS</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GetProductPkgMilestone</targetReference>
            </connector>
            <label>NeedDICreated</label>
        </rules>
    </decisions>
    <decisions>
        <description>Decides if the record getting added to the collection to create new records already has an existing record in the collection with the same product.</description>
        <name>ProductExistsInCollectionDecision</name>
        <label>ProductExistsInCollectionDecision</label>
        <locationX>640</locationX>
        <locationY>567</locationY>
        <defaultConnector>
            <targetReference>LoopNewDepInsCollection</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>NoMatchingRecordInCollection</defaultConnectorLabel>
        <rules>
            <name>ProductExistsInCollection</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>NewDeploymentInstanceRecord.Product2.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>LoopNewDepInsCollection.Product2.Id</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>NewDeploymentInstanceRecord.Product2.DI_Index__r.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>LoopNewDepInsCollection.Product2.DI_Index__r.Name</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LoopSubActRecords</targetReference>
            </connector>
            <label>ProductExistsInCollection</label>
        </rules>
    </decisions>
    <decisions>
        <description>Decides whether a Product has a DI Index or not. If not, the Flow is sent back to the next loop. If it does, it continues on. If a Product does not have a DI Index populated, no DI is needed.</description>
        <name>ProductHasDI_IndexDecision</name>
        <label>Product Has DI Index Decision</label>
        <locationX>839</locationX>
        <locationY>170</locationY>
        <defaultConnector>
            <targetReference>LoopSubActRecords</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No DI Index</defaultConnectorLabel>
        <rules>
            <name>ProductHasDI_Index</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>ProductDetail.DI_Index__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GetProductDI_IndexDetails</targetReference>
            </connector>
            <label>ProductHasDI_Index</label>
        </rules>
    </decisions>
    <description>Creates a Deployment Instance record for each product in a bundle that doesn&apos;t have a corresponding Opportunity Line Item. This is a subloop on the TCSubscriptionActivations flow.</description>
    <interviewLabel>CreateDIBundleProduct {!$Flow.CurrentDateTime}</interviewLabel>
    <label>CreateDIBundleProduct</label>
    <loops>
        <description>Loops through all existing Deployment Instance records and compare the DI Index on the new record to existing DI Indexes on the Account to avoid creating duplicate DI Indexes.</description>
        <name>LoopDIRecords</name>
        <label>LoopDIRecords</label>
        <locationX>1308</locationX>
        <locationY>248</locationY>
        <collectionReference>ExistingDeploymentInstancesColl</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>DIRecordCompareDecision</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>AssignNewDIRecord</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>LoopNewDepInsCollection</name>
        <label>LoopNewDepInsCollection</label>
        <locationX>902</locationX>
        <locationY>499</locationY>
        <collectionReference>CreateNewDeploymentInstanceColl</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>ProductExistsInCollectionDecision</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>AddToCollection</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>LoopSubActRecords</name>
        <label>LoopSubActRecords</label>
        <locationX>357</locationX>
        <locationY>362</locationY>
        <collectionReference>SubscriptionActivationRecordsColl</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>NeedDICreatedDecision</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>CreateDeploymentInstances</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>CreateDeploymentInstances</name>
        <label>CreateDeploymentInstances</label>
        <locationX>374</locationX>
        <locationY>589</locationY>
        <inputReference>CreateNewDeploymentInstanceColl</inputReference>
    </recordCreates>
    <recordLookups>
        <description>Gets the existing Deployment Instances on the Account record</description>
        <name>GetDeploymentInstances</name>
        <label>GetDeploymentInstances</label>
        <locationX>1167</locationX>
        <locationY>51</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>CountExistingDeploymentInstances</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>AccountId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>AccountId</elementReference>
            </value>
        </filters>
        <object>Asset</object>
        <outputReference>ExistingDeploymentInstancesColl</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Product2Id</queriedFields>
        <queriedFields>DI_Index_Name__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Gets the Group ID from the previous portion of the Flow and feeds it through</description>
        <name>GetGroup</name>
        <label>GetGroup</label>
        <locationX>107</locationX>
        <locationY>306</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>GetSubscriptionActivation</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>GroupId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>pse__Grp__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Gets the Opportunity from the previous portions of the Flow and feeds the ID through</description>
        <name>GetOppty</name>
        <label>GetOppty</label>
        <locationX>118</locationX>
        <locationY>185</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>GetGroup</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OppId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Gets the Name of the Deployment Instance Index associated with the Product. This will be used for comparing potential new records against existing DI records on the Account. Only one DI Index can exist on an Account record.</description>
        <name>GetProductDI_IndexDetails</name>
        <label>GetProductDI_IndexDetails</label>
        <locationX>1028</locationX>
        <locationY>55</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>GetDeploymentInstances</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>ProductDetail.DI_Index__c</elementReference>
            </value>
        </filters>
        <object>NI_DeploymentInstanceIndex__c</object>
        <outputReference>DI_Index_Details</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Name</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Gets the Product Package Milestone record that matches the Product Name from the Subscription Activation record. We need this record to find the Id of the Product to create a Deployment Instance record.</description>
        <name>GetProductPkgMilestone</name>
        <label>GetProductPkgMilestone</label>
        <locationX>559</locationX>
        <locationY>50</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>GetProducts</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>TCSubscription_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>LoopSubActRecords.Product_Name__c</elementReference>
            </value>
        </filters>
        <object>PSA_Product_Package_Milestone__c</object>
        <outputReference>ProductPackageMilestone</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Milestone_Name_Prefix__c</queriedFields>
        <queriedFields>Name</queriedFields>
        <queriedFields>TCSubscription_Name__c</queriedFields>
        <queriedFields>Total_Package_Percent__c</queriedFields>
        <queriedFields>Product__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Gets the Product record that corresponds to the Product Package Milestone in the preceding &quot;GetProductPkgMilestone&quot; node.</description>
        <name>GetProducts</name>
        <label>GetProducts</label>
        <locationX>683</locationX>
        <locationY>51</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>ProductHasDI_IndexDecision</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>ProductPackageMilestone.Product__c</elementReference>
            </value>
        </filters>
        <object>Product2</object>
        <outputReference>ProductDetail</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>DI_Index__c</queriedFields>
        <queriedFields>Name</queriedFields>
        <queriedFields>DI_Name_Preview__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Gets the Subscription Activation records attached to the Opportunity. Does not include any SA record where the Product Name contains &quot;Core4&quot; or &quot;Guest Portal&quot;.</description>
        <name>GetSubscriptionActivation</name>
        <label>GetSubscriptionActivation</label>
        <locationX>107</locationX>
        <locationY>483</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>LoopSubActRecords</targetReference>
        </connector>
        <filterLogic>(1) and (NOT(2)) AND (NOT(3))</filterLogic>
        <filters>
            <field>Opportunity__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OppId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Product_Name__c</field>
            <operator>Contains</operator>
            <value>
                <stringValue>Core4</stringValue>
            </value>
        </filters>
        <filters>
            <field>Product_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Guest Portal</stringValue>
            </value>
        </filters>
        <object>Subscription_Activation__c</object>
        <outputReference>SubscriptionActivationRecordsColl</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Product_ID__c</queriedFields>
        <queriedFields>Group__c</queriedFields>
        <queriedFields>Product_Name__c</queriedFields>
        <queriedFields>Account__c</queriedFields>
    </recordLookups>
    <start>
        <locationX>50</locationX>
        <locationY>50</locationY>
        <connector>
            <targetReference>GetOppty</targetReference>
        </connector>
    </start>
    <status>Obsolete</status>
    <variables>
        <name>AccountId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>CountDeploymentInstances</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>CreateNewDeploymentInstanceColl</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Asset</objectType>
    </variables>
    <variables>
        <description>Holds the details of the DI Index record attached to the Product</description>
        <name>DI_Index_Details</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>NI_DeploymentInstanceIndex__c</objectType>
    </variables>
    <variables>
        <name>ExistingDeploymentInstancesColl</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Asset</objectType>
    </variables>
    <variables>
        <name>GroupId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <description>Stores the Milestone Name Prefix from the Product Package Milestone record. This value used to find the corresponding Product record.</description>
        <name>MilestoneNamePrefix</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>NewDeploymentInstanceRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Asset</objectType>
    </variables>
    <variables>
        <name>OppId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <description>Gets the details of the Product that will be used to create a new DI record</description>
        <name>ProductDetail</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Product2</objectType>
    </variables>
    <variables>
        <name>ProductPackageMilestone</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>PSA_Product_Package_Milestone__c</objectType>
    </variables>
    <variables>
        <name>SubscriptionActivationRecordsColl</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Subscription_Activation__c</objectType>
    </variables>
</Flow>
