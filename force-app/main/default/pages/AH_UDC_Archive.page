<apex:page standardcontroller="AH_UDC_Workbook__c" extensions="AH_UDC_Archive" lightningstylesheets="true" showheader="false" applybodytag="true" applyhtmltag="false" doctype="html-5.0">
   <head>
      <title>{!$Label.AH_UDC_Send_Workbook_Title}</title>
      <apex:slds />
   </head>
   <body>
      <!-- Display error message if any error in page -->
      <apex:form id="frmArchive">
         <apex:actionfunction name="actionfunction_LogMessages" action="{!ServerLogMessages}" oncomplete="return false;" />
         <!--Action function to archive workbook-->
         <apex:actionFunction name="archiveWorkbook" action="{!ArchiveWorkbook}" rerender="archivePageMessage,opJS" oncomplete="javascript:archiveWorkbookCompleted();" />

         <!-- Display error message and OK button in case of exception-->
         <apex:outputPanel id="opErrorMessage">
            <apex:pagemessages id="pageMessage" />
            <center style="{!IF(IsErrorOccurred, '', 'display:none;')}">
               <button id="btnOkError" class="slds-button slds-button_brand" onclick="redirectBackToWorkbookRecord(); return false;">{!$Label.AH_UDC_OK}</button>
            </center>
         </apex:outputPanel>

         <!--Display popup if Workbook is already archived-->
         <div class="section-d" id="popupArchiveNotAllowedMessage" style="{!IF(IsErrorOccurred == false && ArchiveNotAllowedMessage != null && ArchiveNotAllowedMessage != '', '', 'display:none')}">
            <section class="slds-popover slds-popover_prompt slds-popover_prompt_top popup-custom popup-custom-border" role="dialog" style="border-color: #0171C0; border-width: 4px; border-radius: 25px; width: 75%; margin-left: -38%;">
               <div class="slds-popover__body">
                  <div class="slds-media">
                     <div class="slds-media__body">
                        <h2 class="slds-modal__title slds-hyphenate slds-text-heading_medium slds-align_absolute-center slds-text-align--center">{!ArchiveNotAllowedMessage}</h2>
                        <div class="slds-var-p-around_xx-small"></div>
                     </div>
                  </div>
               </div>
               <div class="slds-grid slds-align_absolute-center">
                  <button id="btnClose" class="slds-button slds-button_brand" onclick="redirectBackToWorkbookRecord(); return false;">{!$Label.AH_UDC_Close}</button>
               </div>
               <div class="slds-var-p-around_small"></div>
            </section>
         </div>

         <!--Display confirmation message popup for workbook archive-->
         <div id="popupWorkbookArchiveConfirmationMessage" class="slds-text-heading_small" style="{!IF(IsErrorOccurred == false && (ArchiveNotAllowedMessage == null || ArchiveNotAllowedMessage == ''), '', 'display:none')}">
            <section class="slds-popover slds-popover_prompt slds-popover_prompt_top popup-custom popup-custom-border" role="dialog" style="border-color: #0171C0; border-width: 4px; border-radius: 25px; width: 75%; margin-left: -38%;">
               <div class="slds-popover__body">
                  <div class="slds-media">
                     <div class="slds-media__body">
                        <apex:pagemessages id="archivePageMessage" />
                        <h2 class="slds-modal__title slds-hyphenate slds-text-heading_medium slds-align_absolute-center slds-text-align--center">{!$label.AH_UDC_Archive_ConfirmationMessage}</h2>
                        <div class="slds-var-p-around_xx-small"></div>
                     </div>
                  </div>
               </div>
               <div class="slds-grid slds-align_absolute-center">
                  <button id="btnContinue" class="slds-button slds-button_brand" onclick="onContinueClick(); return false;">{!$Label.AH_UDC_Continue}</button>
                  <button id="btnCancel" class="slds-button slds-button_brand" onclick="redirectBackToWorkbookRecord(); return false;">{!$Label.AH_UDC_Cancel}</button>
               </div>
               <div class="slds-var-p-around_small"></div>
            </section>
         </div>

         <apex:outputPanel id="opJS">
            <script type="text/javascript">
               function archiveWorkbookCompleted() {
                  if('{!IsErrorOccurred}'.toLowerCase() == 'true') {
                     document.getElementById('btnContinue').disabled = false;
                     document.getElementById('btnCancel').disabled = false;
                  }
                  else
                     redirectBackToWorkbookRecord(true);
               }
            </script>
         </apex:outputPanel>

         <script type="text/javascript">
            window.onload = (event) => {
               if ('{!HasPageLoadLogMessages}'.toLowerCase() == 'true') {
                  actionfunction_LogMessages();
               }
            };

            function onContinueClick() {
               document.getElementById('btnContinue').disabled = true;
               document.getElementById('btnCancel').disabled = true;
               archiveWorkbook();
            }

            function redirectBackToWorkbookRecord(flagRefreshRecord) {
               var strId = '{!$CurrentPage.parameters.id}';
               if(flagRefreshRecord)
                  //Redirect back to workbook record and refresh data
                  window.parent.location.href = "/" + strId;
               else
                  //Redirect back to workbook record without refreshin data
                  sforce.one.navigateToSObject(strId);
            }
         </script>
      </apex:form>
   </body>
</apex:page>