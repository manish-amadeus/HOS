<apex:page controller="AH_PLCM_User_Xref" action="{!CheckTermsAndConditionStatus}">
    <head>
        <!-- Include CSS -->
        <apex:stylesheet value="{!$Resource.AH_PLCM_Style}" />
        <apex:stylesheet value="{!$Resource.AH_PLCM_Bubble}" />

        <!-- Include JS -->
        <apex:includeScript value="{!$Resource.AH_PLCM_JQuery_341}" />
        <apex:includeScript value="{!$Resource.AH_PLCM_JQuery_FloatThead_Min}" />

        <style type="text/css">
            .header-table { width:86%; }

            .left-bar-show .header-table { width:100%; }
            .header-bubble {
                text-align: left;
            }

            .header-bubble::before { top:-10.5% !important; }

            .new-user-lbl {
                text-align: right;
                padding-right: 5px;
                vertical-align: inherit !important;
                width: 5%;
            }

            .chk-bubble-icon::before { left: 12px !important; }

            .copy-user-bubble::before {
                top: -10% !important;
            }

            .help-show.left-bar-show .new-user-lbl {
                width: 25% !important;
            }

            .left-bar-show .new-user-lbl {
                width: 6% !important;
            }

            .help-show .new-user-lbl {
                width: 9% !important;
            }

            .target-user-lbl {
                text-align: right;
                padding-right: 5px;
                vertical-align: inherit !important;
                width: 5%;
            }

            .help-show.left-bar-show .target-user-lbl {
                width: 28% !important;
            }

            .left-bar-show .target-user-lbl {
                width: 7% !important;
            }

            .help-show .target-user-lbl {
                width: 10% !important;
            }
        </style>
    </head>
    <apex:form id="frmUsers">
        <!-- set project id in hidden field for next post back -->
        <input type="hidden" id="hdnProjectId" name="ProjectId" value="{!ProjectId}" />

        <!-- Progressbar :: Start -->
        <c:AH_PLCM_Progress_Bar IsPropertyUpdated="{!ProjectPortalStatus.IsPropertyUpdated}" IsUsersCreated="{!ProjectPortalStatus.IsUsersCreated}"
        IsXrefCompleted="{!ProjectPortalStatus.IsXrefCompleted}" PerecentageCompleted="{!ProjectPortalStatus.PerecentageCompleted}" />
        <!-- Progressbar :: End -->

        <div style="width:100%; padding:0px;">
            <div class="error-msg">Please fill below required fields to proceed.</div>
            <div class="main-div">
                <div class="main-header">
                    <table class="tbl-header" border="0" cellpadding="0" cellspacing="0">
                        <tbody>
                            <tr>
                                <td class="td-title">
                                    <h2 class="main-title">Transfer User Records</h2>
                                </td>
                                <td style="text-align: right; padding-right: 10px !important;">
                                    <input type="submit" value="Take Tutorial" onclick="javacsript: showBubble(0);return false;" class="btn-common" />
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="main-body">
                    <div style="width:100%; text-align: center;">
                        <table class="tbl-multi-select" border="0" cellpadding="0" cellspacing="0" style="width:{!IF(ddlSalesforceUsers.size > 1, '86%', '100%')};">
                            <tbody>
                                <tr>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">
                                        <h1 style="{!IF(ddlUsers.size > 1 || ddlSalesforceUsers.size > 1, '', 'display:none;')}" id="head-multiselect">Multi-Select</h1>
                                        <div class="bubble-popup" id="divBubblePopup_1" style="padding-top: 15px;">
                                            <div class="property-name-bubble header-bubble">
                                                <section class="bbl-header-text">Assign Users Multi Select</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                                <br/>
                                                    This section allows you to assign records from multiple users to a single user in the new application.<br /><br /><br />
                                                <input onclick="javascript:showBubble(0);" style="float:Left" type="button" value="Previous" />
                                                <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 2, 2)} of {!IF(ddlSalesforceUsers.size == 1, 7,IF(ddlUsers.size == 1,7, 9))}</label>
                                                <input onclick="javascript:showBubble('{!IF(ddlUsers.size == 1, 12, 3)}');" style="float:right" type="button" value="Continue" />
                                            </div>
                                        </div> 

                                        <div class="bubble-popup" id="divBubblePopup_11" style="padding-top: 15px;">
                                            <div class="property-name-bubble header-bubble">
                                                <section class="bbl-header-text">Select Users</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                                <br/>
                                                    Begin by selecting either a new or existing user from one of the picklists. <br /><br /><br />
                                                <input onclick="javascript:showBubble(4);" style="float:Left" type="button" value="Previous" />
                                                <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 1, 5)} of {!IF(ddlSalesforceUsers.size == 1, 7, 9)}</label>
                                                <input onclick="javascript:showBubble(10);" style="float:right" type="button" value="Continue" />
                                            </div>
                                        </div>
                                    </td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                    <td style="width:10%">&nbsp;</td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="tbl-multi-select" style="width:{!IF(ddlSalesforceUsers.size > 1, '100%', '70%')};" border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td class="new-user-lbl">
                                    <b style="{!IF(ddlUsers.size > 1, '', 'display:none;')}">Transfer Records to (New User): </b>
                                </td>
                                <td style="text-align:left; width:2%;">
                                    <select style="{!IF(ddlUsers.size > 1, '', 'display:none;')}" id="ddlCopyNewUser" class="position-relative" onchange="javascript: onChangeCopyUser(this, 'new user');">
                                        <option value="">--None--</option>
                                    </select>
                                    <!--Bubble Help Popup For New User-->
                                    <div class="bubble-popup" id="divBubblePopup_3" >
                                        <div class="property-name-bubble copy-user-bubble" >
                                            <section class="bbl-header-text">Assign Records to New Users</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                            <br/>
                                                This field contains a list of new users to be created by the migration, as indicated on the previous page.{!IF(ddlSalesforceUsers.size == 1, ' Begin by selecting a user to assign records to. ', '')}<br /><br /><br />
                                            <section>
                                                <input onclick="javascript:showBubble(1);" style="float:Left" type="button" value="Previous" />
                                                <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 3, 3)} of {!IF(ddlSalesforceUsers.size == 1, 7, 9)}</label>
                                                <input onclick="javascript:showBubble({!IF(ddlSalesforceUsers.size > 1, 4, 10)});" style="float:right" type="button" value="Continue" />
                                            </section>
                                        </div>
                                    </div> 
                                </td>                               
                                <td id="tdCopyExistingUser" class="target-user-lbl" style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">
                                    <b>Transfer Records to (Existing User): </b>
                                </td>
                                <td style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}text-align:left;width:15%;">
                                    <select id="ddlCopyExistingUser" class="position-relative" onchange="javascript: onChangeCopyUser(this, 'existing user');">
                                        <option value="">--None--</option>
                                    </select>
                                    <div class="bubble-popup" id="divBubblePopup_4" style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">
                                        <div class="property-name-bubble copy-user-bubble copy-existing-user-bubble">
                                            <section class="bbl-header-text">Assign Records to Existing Users</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                            <br/>
                                                Alternately, this field contains a list of existing users already in your new application.<br /><br /><br />
                                            <section>
                                                <input onclick="javascript:showBubble({!IF(ddlSalesforceUsers.size == 1, 2, 3)});" style="float:Left" type="button" value="Previous" />
                                                <label class="lbl-bbl-numbers"> {!IF(ddlSalesforceUsers.size == 1, 1, 4)} of {!IF(ddlSalesforceUsers.size == 1, 7, 9)}</label>
                                                <input onclick="javascript:showBubble(11);" style="float:right" type="button" value="Continue" />
                                            </section>
                                        </div>
                                    </div> 
                                    <div class="bubble-popup" id="divBubblePopup_12" style="{!IF(ddlUsers.size == 1, '', 'display:none;')}">
                                        <div class="property-name-bubble copy-user-bubble copy-existing-user-bubble">
                                            <section class="bbl-header-text">Assign Records to Existing Users</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                            <br/>
                                            This field contains a list of users that are currently active in the new application. Begin by selecting an existing user to assign records to.
                                            <br /><br /><br />
                                            <section>
                                                <input onclick="javascript:showBubble({!IF(ddlSalesforceUsers.size == 1, 2, IF(ddlUsers.size == 1,1,3))});" style="float:Left" type="button" value="Previous" />
                                                <label class="lbl-bbl-numbers"> {!IF(ddlSalesforceUsers.size == 1, 1,IF(ddlUsers.size == 1,3, 4))} of {!IF(ddlSalesforceUsers.size == 1, 7,IF(ddlUsers.size == 1,7,9))}</label>
                                                <input onclick="javascript:showBubble(13);" style="float:right" type="button" value="Continue" />
                                            </section>
                                        </div>
                                    </div> 
                                </td>                              
                            </tr>
                        </table>
                    </div>
                    <div id="divTable" class="data-grid-wrapper">
                        <table id="dataGrid" class="data-grid" border="0" cellpadding="0" cellspacing="0">
                            <thead>
                                <tr class="header-row">
                                    <th style="width:5%; text-align:center;">
                                        <label>Select All</label>
                                        <input id="chkSelectAll" type="checkbox" style="vertical-align: middle;" class="disabled-control" tabindex="-1" />
                                    </th>
                                    <th style="width:10%;">Full Name</th>
                                    <th style="width:15%;">Email</th>
                                    <th style="width:15%;{!IF(ddlUsers.size > 1, '', 'display:none;')}" id="ddl-newUser_0">Transfer Records to (New User)</th>
                                   <!-- <th style="width:20%;">New User's Property</th>-->
                                    <th style="width:15%; {!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">Transfer Records to (Existing User)</th>
                                    <th style="width:20%; {!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">Existing User's Email</th>
                                </tr>
                            </thead>
                            <tbody>
                                <apex:variable var="index" value="{!0}" />
                                <apex:repeat value="{!lstUsers}" var="user">
                                    <tr class="data-row" onmouseover="if (window.hiOn){hiOn(this);} " onmouseout="if (window.hiOff){hiOff(this);} " onblur="if (window.hiOff){hiOff(this);}" onfocus="if (window.hiOn){hiOn(this);}">
                                        <td style="text-align:center;">
                                            <input type="checkbox" class="chk-copy disabled-control" tabindex="-1" onchange="javascript: copyUserMapping(this);" />
                                            <!--Bubble Help Popup For New User-->
                                            <apex:outputPanel rendered="{!(index == 0)}">
                                                <div class="bubble-popup" id="divBubblePopup_10" style="text-align: left !important; " >
                                                    <div class="property-name-bubble chk-bubble-icon" style="left:12px;">
                                                        <section class="bbl-header-text">{!IF(ddlSalesforceUsers.size > 1, 'Use Checkbox to Select Users', 'Select Users')}</section>
                                                        <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                                        <br/>
                                                            Next, select the users you wish to transfer records from by using the checkboxes provided.  Records from these users will then be assigned to the new user chosen in the previous step.<br/><br/><br/>
                                                        <section>
                                                            <input onclick="javascript:showBubble({!IF(ddlSalesforceUsers.size == 1, 3, 11)});" style="float:Left" type="button" value="Previous" />    
                                                            <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 4, 6)} of {!IF(ddlSalesforceUsers.size == 1, 7, 9)}</label>
                                                            <input onclick="javascript:showBubble(5);" style="float:right" type="button" value="Continue" />                                                        
                                                        </section>
                                                    </div>
                                                </div>
                                            </apex:outputPanel> 
                                            <!--Bubble Popup for 0 licenses Existing User-->
                                            <apex:outputPanel rendered="{!(index == 0)}">
                                                <div class="bubble-popup" id="divBubblePopup_13" style="text-align: left !important; " >
                                                    <div class="property-name-bubble chk-bubble-icon" style="left:12px;">
                                                        <section class="bbl-header-text">{!IF(ddlUsers.size == 1, 'Use Checkbox to Select Users', 'Select Users')}</section>
                                                        <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                                        <br/>
                                                        Next, select the users you wish to transfer records from by using the checkboxes provided. Records from these users will then be assigned to the current user chosen in the previous step.<br/><br/><br/>
                                                        <section>
                                                            <input onclick="javascript:showBubble({!IF(ddlSalesforceUsers.size == 1, 3, IF(ddlUsers.size == 1,12,11))});" style="float:Left" type="button" value="Previous" />    
                                                            <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 4, IF(ddlUsers.size == 1,4,6))} of {!IF(ddlSalesforceUsers.size == 1, 7, IF(ddlUsers.size == 1,7,9))}</label>
                                                            <input onclick="javascript:showBubble(14);" style="float:right" type="button" value="Continue" />                                                        
                                                        </section>
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                        </td>
                                        <td>{!user.Name}</td>
                                        <td>{!user.User_Email_Address__c}</td>
                                        <td style="{!IF(ddlUsers.size > 1, '', 'display:none;')}">
                                            <div class="requiredInput{!IF(user.New_User__c, ' disabled-wrapper', '')}">
                                                <div class="requiredBlock" style="display:none;"></div>
                                                <apex:selectList styleClass="ddl-user-id {!IF((user.MappedTo_User__c == '' || user.MappedTo_User__c == null) && (user.MappedTo_PLCM_TargetOrg_User__c == '' || user.MappedTo_PLCM_TargetOrg_User__c == null), ' ddl-empty', '')} {!IF(user.New_User__c, ' disabled-control', '')}" value="{!user.MappedTo_User__c}" onchange="javascript:migrationUserSelected(this, true);" size="1" tabindex="{!IF(user.New_User__c, '-1', '')}" style="min-width:155px;">
                                                    <apex:selectOptions value="{!ddlUsers}"></apex:selectOptions>
                                                </apex:selectList>
                                                <apex:selectList styleClass="ddl-user-name" value="{!user.MappedTo_User_Name__c}" size="1" style="display:none;">
                                                    <apex:selectOptions value="{!ddlUserNames}"></apex:selectOptions>
                                                </apex:selectList>
                                                <apex:selectList styleClass="ddl-user-property" value="{!user.MappedTo_User_Property__c}" size="1" style="display:none;">
                                                    <apex:selectOptions value="{!ddlUserProperties}"></apex:selectOptions>
                                                </apex:selectList>
                                                <input type="hidden" id="hdnRowCount" value="{!index}" />
                                            </div>                                        
                                            <apex:outputPanel rendered="{!(index == 0)}">
                                                <!--Bubble Help Popup For New User-->                                                                            
                                                <!--Bubble Help Popup For New/Existing User-->
                                               
                                                <div class="bubble-popup" id="divBubblePopup_2" style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">
                                                    <div class="property-name-bubble">
                                                        <section class="bbl-header-text">Individual Users</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                                        <br/>
                                                            Individual users can be updated separately in each user row. For more information refer to the help content on the right side of this page.<br /><br /><br />
                                                        <input onclick="javascript:showBubble(5);" style="float:Left" type="button" value="Previous" />
                                                        <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 6, 8)} of {!IF(ddlSalesforceUsers.size == 1, 7, 9)}</label>
                                                        <input onclick="javascript:showBubble(6);" style="float:right" type="button" value="Continue" />
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                        </td>
                                        <!--<td>
                                            <label class="lbl-user-property"></label>
                                        </td>-->
                                        <td style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">
                                            <div class="requiredInput">
                                                <div class="requiredBlock" style="display:none;"></div>
                                                <apex:selectList styleClass="ddl-target-user" value="{!user.MappedTo_PLCM_TargetOrg_User__c}" onchange="javascript:targetUserSelected(this, true);" size="1" style="min-width:155px;">
                                                    <apex:selectOptions value="{!ddlSalesforceUsers}"></apex:selectOptions>
                                                </apex:selectList>
                                                <apex:selectList styleClass="ddl-target-user-email" value="{!SalesforceUserEmail}" size="1" style="display:none;">
                                                    <apex:selectOptions value="{!ddlSalesforceUserEmails}"></apex:selectOptions>
                                                </apex:selectList>
                                                <input type="hidden" id="hdnRowCount" value="{!index}" />
                                            </div>

                                            <apex:outputPanel rendered="{!(index == 0)}">
                                                <!--Bubble Help Popup without New User-->                                                                                                                    
                                               
                                                <div class="bubble-popup" id="divBubblePopup_15" style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">
                                                    <div class="property-name-bubble">
                                                        <section class="bbl-header-text">Individual Users</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                                                        <br/>
                                                            Individual users can be updated separately in each user row. For more information refer to the help content on the right side of this page.<br /><br /><br />
                                                        <input onclick="javascript:showBubble(14);" style="float:Left" type="button" value="Previous" />
                                                        <label class="lbl-bbl-numbers">{!IF(ddlSalesforceUsers.size == 1, 6, IF(ddlUsers.size==1,6,8))} of {!IF(ddlSalesforceUsers.size == 1, 7, IF(ddlUsers.size==1,7,9))}</label>
                                                        <input onclick="javascript:showBubble(6);" style="float:right" type="button" value="Continue" />
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                        </td>
                                        <td style="{!IF(ddlSalesforceUsers.size > 1, '', 'display:none;')}">
                                            <label class="lbl-target-user-email"></label>
                                        </td>
                                    </tr>
                                    <apex:variable var="index" value="{!index + 1}" />
                                </apex:repeat>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="main-footer">
                    <apex:actionFunction action="{!SaveXrefData}" name="SaveXrefData" oncomplete="ConfirmAndSubmit();"/>
                    <apex:actionFunction action="{!ConfirmAndSubmit}" name="ConfirmAndSubmit" />
                    <apex:commandButton value="Back to Users Selection" action="{!BackToCreateUserPage}" style="float:left;"/>
                    <div class="export-menu">
                        <button onclick="$('.menu-options').toggle(); return false;" class="menu-btn btn">Export</button>
                        <div class="menu-options">
                            <a onclick="javascript:exportReport('{!ProjectId}', 'xref', 'xls'); return false;">Excel</a>
                            <a onclick="javascript:exportReport('{!ProjectId}', 'xref', 'pdf'); return false;">PDF</a>
                        </div>
                    </div>    
                    <apex:commandButton value="Save" action="{!SaveXrefData}" onclick="javascript: showHideLoader(true);" style="{!IF(ProjectPortalStatus.IsXrefCompleted == true, 'display:none;', '')}"/>
                    <apex:commandButton value="{!IF(ProjectPortalStatus.IsXrefCompleted == true, 'Next', 'Confirm & Submit')}" action="{!ConfirmAndSubmit}" onclick="javascript: if(validateData()) { $('#divTable table').floatThead('destroy'); showHideLoader(true); SaveXrefData(); } return false;" />
                </div>
            </div>
            <div class="help-wrapper">
                <div class="help-button">
                    <a id="btnHelp">Hide Help</a>
                </div>
                <div class="help-box">
                    <div class="help-box-inner">
                        <div class="help-title">Transfer User’s Records</div>
                        <!--Help Text :: With Target Users-->
                        <div class="help-text" style="{!IF(ddlSalesforceUsers.size > 1 && ddlUsers.size > 1, '', 'display:none;')}">
                            The available user names within the “Transfer Records to (New User)” picklist is generated from the users you decided to have the migration create on the previous page. The users offered in the “Transfer Records to (Existing User)” picklist is populated by all existing active users already in your new application. First, choose one of the users from either of the picklists. Next, identify which users will have their records transferred to this user. Use the checkboxes to select all the user(s) whom you want to transfer records from. These user records will then be assigned to the New or Existing User you selected in the picklist above. 
                            <br/><br/>
                            You’ll notice that the yellow ‘None’ will change to the User chosen from the picklist.  When all your selections for that User have been completed, select another User from one of the picklists and repeat the process, as needed. You can perform these assignments through multiple selections or individual selections. Use the individual user’s picklists in each row to change New User or Existing User assignment values accordingly. Continue working through the entirety of the page in this way until there are no remaining yellow ‘None’ fields.
                            <br/><br/>
                            This assignment exercise ensures all migrating records have an active user as an owner. This is a requirement for the database in your new application.  Only those users holding an active license will be available to own records coming over in your migration. 
                            <br/><br/>
                            Depending on your purchased services, “records” may include Activities(traces) or Activities, Groups, and Functions.  
                            <br/><br/>
                            NOTE: Users in the provided listed rows are all “active” users from your existing application and have access to your property. Some may not be familiar to you in your day-to-day business (i.e. Corporate User), however they still require assignment. They have been identified as owning records associated with one or all the properties included in this migration. 
                            <br/><br/>
                            Feel free to create a report of your configurations by using the "Export to Excel" or "Export to PDF" button.                         
                        </div>

                        <!--Help Text :: Without Target Users-->
                        <div class="help-text" style="{!IF(ddlSalesforceUsers.size == 1 && ddlUsers.size > 1, '', 'display:none;')}">
                            The available user names within the “Transfer Records to (New User)” picklist is generated from the users you decided to have the migration create on the previous page. First, choose one of the users from the picklist. Next, identify which users will have their records transferred to this user. Use the checkboxes to select all the user(s) whom you want to transfer records from. These user records will then be assigned to the New User you selected in the picklist above.
                            <br/><br/>
                            You’ll notice that the yellow ‘None’ will change to the user's name chosen from the picklist.  When all your selections for that User have been completed, select another New User from the picklist and repeat the process, as needed. You can perform these assignments through multiple selections or individual selections. Use the individual user’s picklists in each row to change New User assignment values accordingly. Continue working through the entirety of the page in this way until there are no remaining yellow ‘None’ fields. 
                            <br/><br/>
                            This assignment exercise ensures all migrating records have an active user as an owner. This is a requirement for the database in your new application.  Only those users holding an active license will be available to own records coming over in your migration.
                            <br/><br/>
                            Depending on your purchased services, “records” may include Activities(traces) or Activities, Groups, and Functions.  
                            <br/><br/>
                            NOTE: Users in the listed rows are all “active” users from your existing application and have access to your property. Some may not be familiar to you in your day-to-day business (i.e. Corporate User), however they still require assignment. They have been identified in your database as owning at least one record that is associated with one or all the properties in this migration.
                            <br/><br/>
                            Feel free to create a report of your configurations by using the "Export to Excel" or "Export to PDF" button.
                        </div>

                        <!--Help Text :: With Target Users-0 license scenario-->
                        <div class="help-text" style="{!IF(ddlUsers.size == 1, '', 'display:none;')}">
                            The available user names offered in the “Transfer Records to (Existing User)” picklist is populated by all existing active users already in your new application. First, choose one of the users from the picklist. Next, identify which users will have their records transferred to this user. Use the checkboxes to select all the user(s) whom you want to transfer records from. These user records will then be assigned to the Existing User you selected in the picklist above.
                            <br/><br/>
                            You’ll notice that the yellow ‘None’ will change to the User chosen from the picklist.  When all your selections for that User have been completed, select another User from the picklist and repeat the process, as needed. You can perform these assignments through multiple selections or individual selections. Use the individual user’s picklists in each row to change Existing User assignment values accordingly. Continue working through the entirety of the page in this way until there are no remaining yellow ‘None’ fields.
                            <br/><br/>
                            This assignment exercise ensures all migrating records have an active user as an owner. This is a requirement for the database in your new application.  Only those users holding an active license will be available to own records coming over in your migration.Depending on your purchased services, “records” may include Activities(traces) or Activities, Groups, and Functions. 
                            <br/><br/>
                            NOTE: Users in the provided listed rows are all “active” users from your existing application and have access to your property. Some may not be familiar to you in your day-to-day business (i.e. Corporate User), however they still require assignment. They have been identified as owning records associated with one or all the properties included in this migration.
                            <br/><br/>
                            Feel free to create a report of your configurations by using the "Export to Excel" or "Export to PDF" button. 
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Bubble Help Popup For Default(First) Bubble-->
        <div id="divBubblePopup_0" class="bubble-popup" style="{!IF(ProjectBubbleStatus.IsXrefBubbleSkipped, '', 'display:block;')}">
            <div class="popup-first-last">
                <section class="bbl-header-text">Assign User Records</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                <br/>
                    This page allows you to choose how you want to assign your active user records.<br/><br/><br/>
                <section>
                    <input type="button" value="Skip Tutorial" style="float:Left" onclick="javascript:skipBubble();" />
                    <label class="lbl-bbl-numbers" style="width:60% !important">{!IF(ddlSalesforceUsers.size == 1, 1, IF(ddlUsers.size == 1,1,1))} of {!IF(ddlSalesforceUsers.size == 1, 7, IF(ddlUsers.size == 1,7,9))}</label>
                    <input type="button" value="Start Tutorial" style="float:right;" onclick="javascript:showBubble(1);" />                    
                </section>
            </div>
        </div>
        <!--Final Bubble Help Popup-->
        <div class="bubble-popup" id="divBubblePopup_5">
            <div class="popup-first-last">
                <section class="bbl-header-text">{!IF(ddlSalesforceUsers.size > 1, 'Continue with Additional Users', 'Repeat for Additional Users')}</section>
                <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                <br/>
                    Repeat this process for any other new{!IF(ddlSalesforceUsers.size > 1, ' or existing', '')} user(s) that should have records for multiple users assigned to them. <br /><br /><br />
                <section>
                    <input onclick="javascript:showBubble(10);" style="float:Left" type="button" value="Previous" />
                    <label class="lbl-bbl-numbers" style="width:70% !important">{!IF(ddlSalesforceUsers.size == 1, 5, 7)} of {!IF(ddlSalesforceUsers.size == 1, 7, 9)}</label>
                    <input onclick="javascript:showBubble(2);" style="float:right" type="button" value="Continue" />
                </section>
            </div>
            
        </div>
        <!--Bubble Popup for 0 licence -->
        <div class="bubble-popup" id="divBubblePopup_14">
            <div class="popup-first-last">
                <section class="bbl-header-text">{!IF(ddlUsers.size == 1, 'Continue with Additional Users', 'Repeat for Additional Users')}</section>
                <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                <br/>
                Repeat this process for any other existing user(s) that should have records for multiple users assigned to them. <br /><br /><br />
                <section>
                    <input onclick="javascript:showBubble(13);" style="float:Left" type="button" value="Previous" />
                    <label class="lbl-bbl-numbers" style="width:70% !important">{!IF(ddlSalesforceUsers.size == 1, 5, IF(ddlUsers.size == 1,5, 7))} of {!IF(ddlSalesforceUsers.size == 1, 7, IF(ddlUsers.size == 1,7, 9))}</label>
                    <input onclick="javascript:showBubble(15);" style="float:right" type="button" value="Continue" />
                </section>
            </div>
            
        </div>
        <div class="bubble-popup" id="divBubblePopup_6">
            <div class="popup-first-last">
                <section class="bbl-header-text">Thank You</section> <input id="button" type="button" onclick="javascript:skipBubble();" value="X"  class="btn-close-bubble"/>
                <br/>
                Thank you for completing these steps. When you have confirmed the info, please hit “Confirm and Submit” to complete the migration tool.<br /><br /><br />
                <section>
                    <input onclick="javascript:showBubble('{!IF(ddlUsers.size == 1, 15, 2)}');" style="float:Left" type="button" value="Previous" />
                    <label class="lbl-bbl-numbers" style="width:70% !important">{!IF(ddlSalesforceUsers.size == 1 || ddlUsers.size==1, 7, 9)} of {!IF(ddlSalesforceUsers.size == 1|| ddlUsers.size==1, 7, 9)}</label>
                    <input onclick="javascript:skipBubble();" style="float:right" type="button" value="Close" />
                </section>
            </div>
        </div>
    </apex:form>
    <script type="text/javascript">
        var __sfdcSessionId = '{!GETSESSIONID()}'; //Use to execute SOQL query
    </script>
    <script src="/soap/ajax/28.0/connection.js" type="text/javascript"></script>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function(event) {
        	//Change Page Title
            window.parent.document.title = "Transfer User Records";
            var $form = $(document.getElementById('{!$Component.frmUsers}'));
            setFormAction($form);

            $("#chkSelectAll").on("change", function() {
                $(".chk-copy").each(function() {
                    var parent = $(this).parents(".data-row");
                    if($(".ddl-user-id.disabled-control", parent).length == 0
                        || ($(".ddl-target-user:visible", parent).length > 0 && $(".ddl-target-user.disabled-control", parent).length == 0)) {
                        $(this).prop("checked", $("#chkSelectAll").is(":checked"));
                        $(this).trigger("change");
                    }
                });
            });

            $(".ddl-user-id").each(function() {
                if($(this).val() != '') {
                    //Select user name for all selected users
                    migrationUserSelected(this, false);
                }
            });

            $(".ddl-target-user").each(function() {
                //Disable migration user drop down and show target user email if selected
                targetUserSelected(this, false);
            });

            if('{!ProjectPortalStatus.IsXrefCompleted}'.toLowerCase() == 'true') {
                $(".ddl-user-id").removeClass("ddl-empty");
                $("select").each(function(index, obj) {
                    //If user mapping step is completed then disable all drop downs
                    disableControl(obj, true);
                });

                //Do not display warning message for disabled controls
                unbindNavigationWaring();
            }
            else {
                //Fill drop downs of copy new users and existing users
                fillCopyDropDowns();

                setTimeout(function() {
                    //Display warning message while moving to other tab
                    bindNavigationWaring();
                }, 500);
            }

            

        });

        //Fill options in drop down (copy new users and existing users)
        function fillCopyDropDowns() {
            var arrNewUsers = document.getElementsByClassName("ddl-user-id");
            $("#ddlCopyNewUser").html($(arrNewUsers[0]).html());
            document.getElementById("ddlCopyNewUser").selectedIndex = 0;

            var arrExistingUsers = document.getElementsByClassName("ddl-target-user");
            if($("option", arrExistingUsers[0]).length > 1) { //Fill only if target users exist
                $("#ddlCopyExistingUser").html($(arrExistingUsers[0]).html());
                document.getElementById("ddlCopyExistingUser").selectedIndex = 0;
            }
        }

        //Funcrtion being call on change of any of the drop down (copy new users and existing users)
        function onChangeCopyUser(elem, type) {
            if(type == 'new user') {
                if($(elem).val() != '') {
                    $('#ddlCopyExistingUser').addClass('ddl-disabled');
                }
                else {
                    $('#ddlCopyExistingUser').removeClass('ddl-disabled');
                }
            } 
            else if(type == 'existing user') {
                if($(elem).val() != '') {
                    $('#ddlCopyNewUser').addClass('ddl-disabled');
                }
                else {
                    $('#ddlCopyNewUser').removeClass('ddl-disabled');
                }
            }

            $(".chk-copy").prop("checked", false);
            $("#chkSelectAll").prop("checked", false);
            if($(elem).val() == "") { //If user not selected then disable all check boxes
                $("#chkSelectAll").addClass("disabled-control");
                $("#chkSelectAll").attr('tabindex', '-1');
                $(".chk-copy").addClass("disabled-control");
                $(".chk-copy").attr('tabindex', '-1');
            }
            else {
                $("#chkSelectAll").removeClass("disabled-control");
                $("#chkSelectAll").removeAttr('tabindex');

                $(".chk-copy").each(function(index, obj) {
                    var parentElem = $(obj).parents(".data-row");
                    if($(".ddl-user-id", parentElem).val() == "" || $(".ddl-user-id", parentElem).hasClass("disabled-control") == false) {
                        $(".chk-copy", parentElem).removeClass("disabled-control");
                        $(".chk-copy", parentElem).removeAttr('tabindex');
                    }
                });
            }
        }

        //Function being called on click of copy checkbox
        function copyUserMapping(elem) {
            var parentElem = $(elem).parents(".data-row");
            var $ddlNewUser = $(".ddl-user-id", parentElem);
            var $ddlExistingUser = $(".ddl-target-user", parentElem);
            var newUserValue = "", existingUserValue = "";

            if($(elem).is(':checked')) {
                $ddlNewUser.data("value", $ddlNewUser.val()); //Save previous new user value
                $ddlExistingUser.data("value", $ddlExistingUser.val()); //Save previous existing user value

                if($("#ddlCopyNewUser").val() != '') { //New user selected for copy
                    newUserValue = $("#ddlCopyNewUser").val();
                }
                else if($("#ddlCopyExistingUser").val() != '') { //Existing user selected for copy
                    existingUserValue = $("#ddlCopyExistingUser").val();
                }

                var totalCheckboxes = $(".chk-copy").length - $(".chk-copy.disabled-control").length;
                var totalCheckedCheckboxes = $(".chk-copy:checked").length;
                if(totalCheckboxes == totalCheckedCheckboxes) { //All checkboxes are checked
                    //Check select all checkbox
                    $("#chkSelectAll").prop("checked", true);
                }
            }
            else {
                newUserValue = $ddlNewUser.data("value"); //Select previous value
                existingUserValue = $ddlExistingUser.data("value"); //Select previous value
                $("#chkSelectAll").prop("checked", false); //Uncheck select all checkbox
            }
            if(newUserValue != "") {
                disableControl($ddlNewUser, false);
            }
            $ddlNewUser.val(newUserValue);
            $ddlExistingUser.val(existingUserValue);
            migrationUserSelected($ddlNewUser.get(0), false);
            targetUserSelected($ddlExistingUser.get(0), false);
        }

        //Function being called on change of target user selection
        function targetUserSelected(elem, flagResetCheckbox) {
            var RowCount = parseInt($(elem).siblings('#hdnRowCount').val());
            var ddlUsers = document.getElementsByClassName('ddl-user-id');
            if('{!ProjectPortalStatus.IsXrefCompleted}'.toLowerCase() == 'false') {
                var currentRow = $(elem).parents(".data-row");

                if(typeof(flagResetCheckbox) != "undefined" && flagResetCheckbox == true) {
                    $(".chk-copy", currentRow).prop("checked", false);
                    $("#chkSelectAll").prop("checked", false);
                }
                if($(elem).val() != '') {
                    //Disable hsp user drop down if target user selected
                    disableControl(ddlUsers[RowCount], true);

                    $(ddlUsers[RowCount]).val('');
                    $(elem).removeClass('ddl-empty'); //Remove yellow - target user
                    $(ddlUsers[RowCount]).removeClass('ddl-empty'); //Remove yellow - migration user
                    $(".requiredBlock", currentRow).hide(); //Hide red block
                }
                else if($(ddlUsers[RowCount]).val() == "") {
                    //Enable hsp user drop down if target user not selected
                    disableControl(ddlUsers[RowCount], false);

                    $(elem).addClass('ddl-empty'); //Fill with yellow - traget user
                    $(ddlUsers[RowCount]).addClass('ddl-empty'); //Fill with yellow - migration user
                    $(".requiredBlock", currentRow).show(); //Show red block
                }
            }

            //Set selected value in email drop down
            var ddlTargetUserEmail = $(elem).siblings('.ddl-target-user-email');
            ddlTargetUserEmail.val($(elem).val());

            //Set email in label text
            var arrLabels = document.getElementsByClassName('lbl-target-user-email');
            var lblEmail = $(arrLabels[RowCount]);
            lblEmail.html($("option:selected", ddlTargetUserEmail).text());
            if($(elem).val() != '') {
                //If target user selected then display email
                lblEmail.show();
            }
            else {
                //Target user not selected then hide email
                lblEmail.hide();                
            }
        }

        //Function being called on selecting migratiion user
        function migrationUserSelected(elem, flagResetCheckbox) {
            var RowCount = parseInt($(elem).siblings('#hdnRowCount').val());
            //Select user from user name drop down
            $(elem).siblings('.ddl-user-name').prop('selectedIndex', elem.selectedIndex);
            $(elem).siblings('.ddl-user-property').prop('selectedIndex', elem.selectedIndex); 
            //var lblProperties = document.getElementsByClassName('lbl-user-property');
            //$(lblProperties[RowCount]).text($(elem).siblings('.ddl-user-property').val());

            var ddlTargetUsers = document.getElementsByClassName('ddl-target-user');
            var currentRow = $(elem).parents(".data-row");
            if(typeof(flagResetCheckbox) != "undefined" && flagResetCheckbox == true) {
                $(".chk-copy", currentRow).prop("checked", false);
                $("#chkSelectAll").prop("checked", false);
            }
            if($(elem).val() != '') {
                $(elem).removeClass('ddl-empty'); //Remove yellow - migration user
                $(".requiredBlock", currentRow).hide(); //Hide red block
                if(parseInt('{!ddlSalesforceUsers.size}') > 1) {
                    //If user selected from hsp users then disable target user drop down
                    disableControl(ddlTargetUsers[RowCount], true);
                    $(ddlTargetUsers[RowCount]).val('');
                    $(ddlTargetUsers[RowCount]).removeClass('ddl-empty'); //Remove yellow - target user
                }
            }
            else if(parseInt('{!ddlSalesforceUsers.size}') > 1) {
                //If user not selected from hsp users then enable target user drop down
                disableControl(ddlTargetUsers[RowCount], false);
                
                if($(ddlTargetUsers[RowCount]).val() == "") {
                    $(elem).addClass('ddl-empty'); //Fill with yellow - migration user
                    $(ddlTargetUsers[RowCount]).addClass('ddl-empty'); //Fill with yellow - target user
                    $(".requiredBlock", currentRow).show(); //Show red block
                }
                else {
                    $(elem).removeClass('ddl-empty'); //Remove yellow
                }
            }
            else {
                $(elem).addClass('ddl-empty'); //Fill with yellow - migration user
                $(".requiredBlock", currentRow).show(); //Show red block
            }
        }

        //Validate data while submitting details
    	function validateData() {
            if('{!ProjectPortalStatus.IsXrefCompleted}'.toLowerCase() == 'false') {
                var flagError = false;
                $(".ddl-user-id").each(function() {
                    if($(this).val() == '') {
                        var RowCount = parseInt($(this).siblings('#hdnRowCount').val());
                        var ddlTargetUsers = document.getElementsByClassName('ddl-target-user');
                        if($(ddlTargetUsers[RowCount]).length == 0 || $(ddlTargetUsers[RowCount]).val() == '') {
                            flagError = true;
                        }
                    }
                });

                $(".error-msg").hide(); //Hide error message
                if(flagError) {
                    $(".error-msg").show(); //Show error message
                    $('html, body').animate({
                        scrollTop: 0
                    }, 1000);
                    return false;
                }
            	else {
                    return confirm("You will no longer be able to change your selections.  Do you want to proceed?");
                }
            }
            else {
            	return true;
            }
        }
        
        //Display bubble help popup
        function showBubble(index) {
            //Hide all bubble help popup
            $(".bubble-popup").hide();
            $("#divBubblePopup_" + index).show(); //Show next or prevous popup

            var currentHeight = $('.main-div').outerHeight() - $(".help-title").outerHeight() - 20;
            $(".help-text").css('height', currentHeight);
        }
        
        //Function is being used to skip bubble popup
        function skipBubble() {
            if('{!ProjectBubbleStatus.IsXrefBubbleSkipped}'.toLowerCase() != 'true') {
                //Update bubble help popup flag in NI Doc record
                updateBubbleFlag('{!ProjectId}', 'user mapping');
            }
            $('.bubble-popup').hide(); //Hide Bubble Popup
        }
    </script>
</apex:page>